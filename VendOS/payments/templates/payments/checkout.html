{% extends "main/base.html" %}
{% load static %}

{% block content %}
<div class="checkout-screen">
    <div class="checkout-card">
        <div class="product-name">{{ product.name }}</div>
        <div class="product-price">â‚¬{{ product.price }}</div>
        <div class="qr-code">
            <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="Scan to pay">
        </div>
        <div class="instruction">Scan the QR code to complete your purchase. The product will be dispensed from slot {{product.slot_id}}.</div>
        <div id="payment-status" style="margin-top:20px;"></div>

        <!-- ðŸ†• Cancel button -->
        <button type="button" id="cancel" class="cancel-btn">Cancel</button>
    </div>
</div>

<script>
const sessionId = "{{ stripe_session_id }}";
const statusDiv = document.getElementById("payment-status");
const redirectUrl = "{{ redirect_URL }}"; // success page
const returnUrl = "{% url 'splash_screen' %}"; // fallback URL
const cancelBtn = document.getElementById("cancel");
const errorUrl = "{% url 'error_page' %}"; // Error page

// Generate the URL using Django template tag
const checkPaymentUrl = "{% url 'check-payment' 'SESSION_ID_PLACEHOLDER' %}".replace('SESSION_ID_PLACEHOLDER', sessionId);

let cancelled = false;

// Cancel button handler
cancelBtn.addEventListener("click", () => {
    cancelled = true;
    statusDiv.innerText = "Cancelling and returning...";
    setTimeout(() => {
        window.location.href = returnUrl;
    }, 1000);
});

function checkPayment() {
    if (cancelled) return;

    fetch(checkPaymentUrl)
        .then(response => response.json())
        .then(data => {
            if (cancelled) return;

            // Redirect to error page if there is an error
            if (data.error) {  // assumes backend sets error=true on error
                console.log("Error detected:", data);
                window.location.href = errorUrl;
                return;
            }

            if (data.paid) {
                statusDiv.innerText = "Payment received! Dispensing product...";
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                statusDiv.innerText = "Waiting for payment...";
                setTimeout(checkPayment, 2000);
            }
        })
        .catch(err => {
            console.error(err);
            if (!cancelled) setTimeout(checkPayment, 5000);
        });
}
setTimeout(checkPayment, 5000);
</script>

<style>
.cancel-btn:hover {
    background-color: #a00000;
}
</style>
{% endblock content %}