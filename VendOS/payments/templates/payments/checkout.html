{% extends "main/base.html" %}
{% load static %}

{% block content %}
<div class="checkout-screen">
    <div class="checkout-card">
        <div class="product-name">{{ product.name }}</div>
        <div class="product-price">â‚¬{{ product.price }}</div>
        <div class="qr-code">
            <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="Scan to pay">
        </div>
        <div class="instruction">Scan the QR code to complete your purchase</div>
        <div id="payment-status" style="margin-top:20px;"></div>
    </div>
</div>

<script>
const sessionId = "{{ stripe_session_id }}";
const statusDiv = document.getElementById("payment-status");
const redirectUrl = "{{ redirect_URL }}"; // success page
const returnUrl = "{% url 'splash_screen' %}"; // fallback URL

// Generate the URL using Django template tag
const checkPaymentUrl = "{% url 'check-payment' 'SESSION_ID_PLACEHOLDER' %}".replace('SESSION_ID_PLACEHOLDER', sessionId);

let startTime = Date.now(); // track when checking started
const MAX_WAIT_TIME = {{ time_out }} * 1000; // convert to milliseconds

function checkPayment() {
    const elapsed = Date.now() - startTime;

    if (elapsed >= MAX_WAIT_TIME) {
        statusDiv.innerText = "Payment not confirmed in time. Returning...";
        setTimeout(() => {
            window.location.href = returnUrl;
        }, 2000);
        return;
    }

    fetch(checkPaymentUrl)
        .then(response => response.json())
        .then(data => {
            if (data.paid) {
                statusDiv.innerText = "Payment received! Dispensing product...";
                // Redirect to success page
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                statusDiv.innerText = "Waiting for payment...";
                setTimeout(checkPayment, 2000);
            }
        })
        .catch(err => {
            console.error(err);
            setTimeout(checkPayment, 5000);
        });
}

// start polling
checkPayment();
</script>
{% endblock content %}